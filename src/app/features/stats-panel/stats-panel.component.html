<div
  class="stats-backdrop"
  [class.hidden]="!open"
  (click)="close.emit()"
>
  <div class="stats-dialog" (click)="$event.stopPropagation()">
    <!-- CABECERA -->
    <div class="stats-header">
      <h3>
        Estadísticas · {{ player?.name }} (#{{ player?.number }})
      </h3>
      <button type="button" class="btn-secondary" (click)="close.emit()">
        Cerrar
      </button>
    </div>

    <!-- CONTEXTO: TEMPORADA + PARTIDO -->
    <div class="stats-context">
      <div class="context-field">
        <label>
          <span>Temporada</span>
          <select
            [(ngModel)]="selectedSeasonId"
            (ngModelChange)="onSeasonChange($event)"
          >
            <option [ngValue]="null">Selecciona temporada</option>
            <option *ngFor="let s of seasons" [ngValue]="s.id">
              {{ s.name }}
            </option>
          </select>
        </label>
      </div>

      <div class="context-field">
        <label>
          <span>Partido</span>
          <select
            [(ngModel)]="selectedMatchId"
            (ngModelChange)="onMatchChange($event)"
            [disabled]="!selectedSeasonId || matches.length === 0"
          >
            <option [ngValue]="null">Selecciona partido</option>
            <option *ngFor="let m of matches" [ngValue]="m.id">
              J{{ m.matchday }} ·
              {{ m.match_date | date: 'dd/MM' }} · vs {{ m.opponent }}
            </option>
          </select>
        </label>
      </div>
    </div>

    <!-- FORMULARIO DEL PARTIDO SELECCIONADO -->
    <form class="stats-form" [formGroup]="form" (ngSubmit)="save()">
      <label class="field">
        <span>Puntos</span>
        <div class="stepper">
          <button type="button" class="stepper-btn" (click)="dec('points')" aria-label="Restar puntos">
            <svg class="stepper-icon" viewBox="0 0 24 24" aria-hidden="true">
              <line x1="6" y1="12" x2="18" y2="12"></line>
            </svg>
          </button>
          <input type="number" formControlName="points" class="stepper-input" />
          <button type="button" class="stepper-btn" (click)="inc('points')" aria-label="Sumar puntos">
            <svg class="stepper-icon" viewBox="0 0 24 24" aria-hidden="true">
              <line x1="12" y1="6" x2="12" y2="18"></line>
              <line x1="6" y1="12" x2="18" y2="12"></line>
            </svg>
          </button>
        </div>
      </label>

      <label class="field">
        <span>Aces</span>
        <div class="stepper">
          <button type="button" class="stepper-btn" (click)="dec('aces')" aria-label="Restar aces">
            <svg class="stepper-icon" viewBox="0 0 24 24" aria-hidden="true">
              <line x1="6" y1="12" x2="18" y2="12"></line>
            </svg>
          </button>
          <input type="number" formControlName="aces" class="stepper-input" />
          <button type="button" class="stepper-btn" (click)="inc('aces')" aria-label="Sumar aces">
            <svg class="stepper-icon" viewBox="0 0 24 24" aria-hidden="true">
              <line x1="12" y1="6" x2="12" y2="18"></line>
              <line x1="6" y1="12" x2="18" y2="12"></line>
            </svg>
          </button>
        </div>
      </label>

      <label class="field">
        <span>Ataques</span>
        <div class="stepper">
          <button type="button" class="stepper-btn" (click)="dec('attacks')" aria-label="Restar ataques">
            <svg class="stepper-icon" viewBox="0 0 24 24" aria-hidden="true">
              <line x1="6" y1="12" x2="18" y2="12"></line>
            </svg>
          </button>
          <input type="number" formControlName="attacks" class="stepper-input" />
          <button type="button" class="stepper-btn" (click)="inc('attacks')" aria-label="Sumar ataques">
            <svg class="stepper-icon" viewBox="0 0 24 24" aria-hidden="true">
              <line x1="12" y1="6" x2="12" y2="18"></line>
              <line x1="6" y1="12" x2="18" y2="12"></line>
            </svg>
          </button>
        </div>
      </label>

      <label class="field">
        <span>Bloqueos</span>
        <div class="stepper">
          <button type="button" class="stepper-btn" (click)="dec('blocks')" aria-label="Restar bloqueos">
            <svg class="stepper-icon" viewBox="0 0 24 24" aria-hidden="true">
              <line x1="6" y1="12" x2="18" y2="12"></line>
            </svg>
          </button>
          <input type="number" formControlName="blocks" class="stepper-input" />
          <button type="button" class="stepper-btn" (click)="inc('blocks')" aria-label="Sumar bloqueos">
            <svg class="stepper-icon" viewBox="0 0 24 24" aria-hidden="true">
              <line x1="12" y1="6" x2="12" y2="18"></line>
              <line x1="6" y1="12" x2="18" y2="12"></line>
            </svg>
          </button>
        </div>
      </label>

      <label class="field">
        <span>Defensas</span>
        <div class="stepper">
          <button type="button" class="stepper-btn" (click)="dec('digs')" aria-label="Restar defensas">
            <svg class="stepper-icon" viewBox="0 0 24 24" aria-hidden="true">
              <line x1="6" y1="12" x2="18" y2="12"></line>
            </svg>
          </button>
          <input type="number" formControlName="digs" class="stepper-input" />
          <button type="button" class="stepper-btn" (click)="inc('digs')" aria-label="Sumar defensas">
            <svg class="stepper-icon" viewBox="0 0 24 24" aria-hidden="true">
              <line x1="12" y1="6" x2="12" y2="18"></line>
              <line x1="6" y1="12" x2="18" y2="12"></line>
            </svg>
          </button>
        </div>
      </label>

      <label class="field">
        <span>Recepciones</span>
        <div class="stepper">
          <button type="button" class="stepper-btn" (click)="dec('receptions')" aria-label="Restar recepciones">
            <svg class="stepper-icon" viewBox="0 0 24 24" aria-hidden="true">
              <line x1="6" y1="12" x2="18" y2="12"></line>
            </svg>
          </button>
          <input type="number" formControlName="receptions" class="stepper-input" />
          <button type="button" class="stepper-btn" (click)="inc('receptions')" aria-label="Sumar recepciones">
            <svg class="stepper-icon" viewBox="0 0 24 24" aria-hidden="true">
              <line x1="12" y1="6" x2="12" y2="18"></line>
              <line x1="6" y1="12" x2="18" y2="12"></line>
            </svg>
          </button>
        </div>
      </label>

      <label class="field">
        <span>Asistencias</span>
        <div class="stepper">
          <button type="button" class="stepper-btn" (click)="dec('assists')" aria-label="Restar asistencias">
            <svg class="stepper-icon" viewBox="0 0 24 24" aria-hidden="true">
              <line x1="6" y1="12" x2="18" y2="12"></line>
            </svg>
          </button>
          <input type="number" formControlName="assists" class="stepper-input" />
          <button type="button" class="stepper-btn" (click)="inc('assists')" aria-label="Sumar asistencias">
            <svg class="stepper-icon" viewBox="0 0 24 24" aria-hidden="true">
              <line x1="12" y1="6" x2="12" y2="18"></line>
              <line x1="6" y1="12" x2="18" y2="12"></line>
            </svg>
          </button>
        </div>
      </label>

      <label class="field">
        <span>Errores forzados</span>
        <div class="stepper">
          <button type="button" class="stepper-btn" (click)="dec('forced_errors')" aria-label="Restar errores forzados">
            <svg class="stepper-icon" viewBox="0 0 24 24" aria-hidden="true">
              <line x1="6" y1="12" x2="18" y2="12"></line>
            </svg>
          </button>
          <input type="number" formControlName="forced_errors" class="stepper-input" />
          <button type="button" class="stepper-btn" (click)="inc('forced_errors')" aria-label="Sumar errores forzados">
            <svg class="stepper-icon" viewBox="0 0 24 24" aria-hidden="true">
              <line x1="12" y1="6" x2="12" y2="18"></line>
              <line x1="6" y1="12" x2="18" y2="12"></line>
            </svg>
          </button>
        </div>
      </label>

      <label class="field field-full">
        <span>Errores no forzados</span>
        <div class="stepper">
          <button type="button" class="stepper-btn" (click)="dec('unforced_errors')" aria-label="Restar errores no forzados">
            <svg class="stepper-icon" viewBox="0 0 24 24" aria-hidden="true">
              <line x1="6" y1="12" x2="18" y2="12"></line>
            </svg>
          </button>
          <input type="number" formControlName="unforced_errors" class="stepper-input" />
          <button type="button" class="stepper-btn" (click)="inc('unforced_errors')" aria-label="Sumar errores no forzados">
            <svg class="stepper-icon" viewBox="0 0 24 24" aria-hidden="true">
              <line x1="12" y1="6" x2="12" y2="18"></line>
              <line x1="6" y1="12" x2="18" y2="12"></line>
            </svg>
          </button>
        </div>
      </label>

      <!-- Mensaje UI -->
      <p *ngIf="uiMessage" class="ui-message">
        {{ uiMessage }}
      </p>

      <div class="actions">
        <button type="submit" class="btn-primary">
          Guardar
        </button>
        <button
          type="button"
          class="btn-secondary"
          (click)="close.emit()"
        >
          Cancelar
        </button>
      </div>
    </form>

    <!-- RESUMEN / HISTÓRICO -->
    <div class="stats-summary">
      <h4>Resumen temporada seleccionada</h4>

      <div *ngIf="loadingSummary" class="summary-loading">
        Cargando estadísticas...
      </div>

      <div *ngIf="summaryError" class="summary-error">
        {{ summaryError }}
      </div>

      <ng-container *ngIf="!loadingSummary && !summaryError">
        <ng-container *ngIf="seasonSummary; else noSeasonData">
          <div class="summary-grid">
            <div class="summary-item">
              <span class="summary-label">Puntos</span>
              <span class="summary-value">
                {{ seasonSummary.total_points }}
              </span>
            </div>
            <div class="summary-item">
              <span class="summary-label">Aces</span>
              <span class="summary-value">
                {{ seasonSummary.total_aces }}
              </span>
            </div>
            <div class="summary-item">
              <span class="summary-label">Ataques</span>
              <span class="summary-value">
                {{ seasonSummary.total_attacks }}
              </span>
            </div>
            <div class="summary-item">
              <span class="summary-label">Bloqueos</span>
              <span class="summary-value">
                {{ seasonSummary.total_blocks }}
              </span>
            </div>
            <div class="summary-item">
              <span class="summary-label">Defensas</span>
              <span class="summary-value">
                {{ seasonSummary.total_digs }}
              </span>
            </div>
            <div class="summary-item">
              <span class="summary-label">Recepciones</span>
              <span class="summary-value">
                {{ seasonSummary.total_receptions }}
              </span>
            </div>
            <div class="summary-item">
              <span class="summary-label">Asistencias</span>
              <span class="summary-value">
                {{ seasonSummary.total_assists }}
              </span>
            </div>
            <div class="summary-item">
              <span class="summary-label">Err. forzados</span>
              <span class="summary-value">
                {{ seasonSummary.total_forced_errors }}
              </span>
            </div>
            <div class="summary-item">
              <span class="summary-label">Err. no forzados</span>
              <span class="summary-value">
                {{ seasonSummary.total_unforced_errors }}
              </span>
            </div>
          </div>
        </ng-container>

        <ng-template #noSeasonData>
          <p class="summary-empty">
            No hay estadísticas registradas para esta temporada.
          </p>
        </ng-template>

        <div class="summary-matches" *ngIf="matchHistory.length">
          <h5>Partidos de la temporada</h5>
          <div
            class="table-wrapper"
            style="max-height: 220px; overflow-y: auto; overflow-x: hidden;"
          >
            <table>
              <thead>
                <tr>
                  <th>Jor.</th>
                  <th>Fecha</th>
                  <th>Rival</th>
                  <th>Pts</th>
                  <th>Ata</th>
                  <th>Blo</th>
                  <th>Def</th>
                  <th>Err F.</th>
                  <th>Err NF.</th>
                </tr>
              </thead>
              <tbody>
                <tr *ngFor="let m of matchHistory">
                  <td>{{ m.matchday }}</td>
                  <td>{{ m.match_date | date: 'dd/MM' }}</td>
                  <td>{{ m.opponent }}</td>
                  <td>{{ m.points }}</td>
                  <td>{{ m.attacks }}</td>
                  <td>{{ m.blocks }}</td>
                  <td>{{ m.digs }}</td>
                  <td>{{ m.forced_errors }}</td>
                  <td>{{ m.unforced_errors }}</td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
      </ng-container>
    </div>
  </div>
</div>
